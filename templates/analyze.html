
<!DOCTYPE html>

<html lang="ko">
<head>
<meta charset="utf-8"/>
<title>ì •ì‚° ë¶„ì„</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { font-family: sans-serif; padding: 20px; }
    .filters { margin-bottom: 20px; }
    .card { display: inline-block; margin: 10px; padding: 10px 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
    .card-title { font-weight: bold; margin-bottom: 5px; }
    .card-value { font-size: 20px; color: #007bff; }
    canvas { margin-top: 30px; }
  </style>
</head>
<body>
<h2>ğŸ“Š ì •ì‚° ë¶„ì„</h2>
<div class="filters">
<label>ì‹œì‘ì¼: <input id="from-date" type="date"/></label>
<label>ì¢…ë£Œì¼: <input id="to-date" type="date"/></label>
<label><input checked="" id="include-sat" type="checkbox"/> í† ìš”ì¼ í¬í•¨</label>
<label><input checked="" name="unit" type="radio" value="day"/> ì¼ ë‹¨ìœ„</label>
<label><input name="unit" type="radio" value="month"/> ì›” ë‹¨ìœ„</label>
<button onclick="loadAnalysis()">ğŸ” ë¶„ì„í•˜ê¸°</button>
<a href="/calendar" style="margin-left: 20px;">ğŸ“… ë‹¬ë ¥ìœ¼ë¡œ ì´ë™</a>
</div>
<div id="summary-cards"></div>
<canvas height="100" id="trend-chart"></canvas>
<canvas height="80" id="prescription-chart"></canvas>
<script>
    async function loadAnalysis() {
      const from = document.getElementById('from-date').value;
      const to = document.getElementById('to-date').value;
      const includeSat = document.getElementById('include-sat').checked;
      const unit = document.querySelector('input[name="unit"]:checked').value;

      const url = `/report/analyze?start=${from}&end=${to}&include_saturday=${includeSat}&unit=${unit}`;
      const res = await axios.get(url);
      const data = res.data;

      const summary = data.summary;
      const trend = data.trend;
      console.log("ğŸ“Š trend ë°ì´í„°:", trend);

      const labelPrefix = unit === 'month' ? 'ì›”' : 'ì¼';

      
      document.getElementById('summary-cards').innerHTML = `
        <div class="card"><div class="card-title">ì´ ë§¤ì¶œ</div><div class="card-value">â‚©${summary.total_sales.toLocaleString()}</div></div>
        <div class="card"><div class="card-title">${labelPrefix} í‰ê·  ë§¤ì¶œ</div><div class="card-value">â‚©${summary.average_sales.toLocaleString()}</div></div>
        <div class="card"><div class="card-title">ìµœê³  ë§¤ì¶œ ${unit === 'month' ? 'ì›”' : 'ì¼'}</div><div class="card-value">${summary.max_sales_date}</div></div>
        <div class="card"><div class="card-title">ìµœì € ë§¤ì¶œ ${unit === 'month' ? 'ì›”' : 'ì¼'}</div><div class="card-value">${summary.min_sales_date}</div></div>
        <div class="card"><div class="card-title">ì´ ì²˜ë°©</div><div class="card-value">${summary.total_prescriptions}ê±´</div></div>
        <div class="card"><div class="card-title">${labelPrefix} í‰ê·  ì²˜ë°©</div><div class="card-value">${summary.average_prescriptions}ê±´</div></div>
        <div class="card"><div class="card-title">ìµœê³  ì²˜ë°©ê±´ìˆ˜</div><div class="card-value">${summary.max_prescriptions_date}</div></div>
        <div class="card"><div class="card-title">ìµœì € ì²˜ë°©ê±´ìˆ˜</div><div class="card-value">${summary.min_prescriptions_date}</div></div>
      `;
    

      if (window.trendChart) window.trendChart.destroy();
      if (window.presChart) window.presChart.destroy();

      const ctx1 = document.getElementById('trend-chart').getContext('2d');
      window.trendChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: trend.map(d => d.date),
          datasets: [{
            label: unit === 'month' ? 'ì›” ë§¤ì¶œ' : 'ì¼ ë§¤ì¶œ',
            data: trend.map(d => d.sales),
            borderColor: '#007bff',
            fill: false,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              title: { display: true, text: unit === 'month' ? 'ì›”' : 'ë‚ ì§œ' },
              ticks: {
                autoSkip: unit !== 'month',
                maxTicksLimit: unit === 'month' ? undefined : 31
              }
            },
            y: { title: { display: true, text: 'ë§¤ì¶œ (â‚©)' }}
          }
        }
      });

      const ctx2 = document.getElementById('prescription-chart').getContext('2d');
      window.presChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: trend.map(d => d.date),
          datasets: [{
            label: unit === 'month' ? 'ì›” ì²˜ë°©ê±´ìˆ˜' : 'ì¼ ì²˜ë°©ê±´ìˆ˜',
            data: trend.map(d => d.prescriptions || 0),
            borderColor: '#28a745',
            fill: false,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              title: { display: true, text: unit === 'month' ? 'ì›”' : 'ë‚ ì§œ' },
              ticks: {
                autoSkip: unit !== 'month',
                maxTicksLimit: unit === 'month' ? undefined : 31
              }
            },
            y: { title: { display: true, text: 'ì²˜ë°© ê±´ìˆ˜' }}
          }
        }
      });
    }

    const today = new Date().toISOString().slice(0, 10);
    document.getElementById('from-date').value = today.slice(0, 8) + '01';
    document.getElementById('to-date').value = today;
    loadAnalysis();
  </script>
</body>
</html>
